<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #764ba2, #667eea);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        /* Employee List Styles */
        .employee-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.8);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .employee-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .employee-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .employee-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .status-active {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-inactive {
            background: #dc3545;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #dc3545;
        }

        /* Settings Styles */
        .settings-section {
            background: rgba(102, 126, 234, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .settings-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            margin-bottom: 5px;
            border-radius: 8px;
            background: white;
        }

        .dropdown-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .notification-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 10px;
            background: white;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(30px);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-firebase {
            background: #28a745;
            color: white;
        }

        .connection-local {
            background: #ffc107;
            color: black;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                justify-content: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .employee-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .employee-table {
                font-size: 0.9rem;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">
        <i class="fas fa-wifi"></i> Connecting...
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-users-cog"></i> HR Management System</h1>
            <nav class="nav-tabs">
                <button class="tab-btn active" onclick="openTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-btn" onclick="openTab('employee-entry')">
                    <i class="fas fa-user-plus"></i> Add Employee
                </button>
                <button class="tab-btn" onclick="openTab('employee-list')">
                    <i class="fas fa-users"></i> Employee Database
                </button>
                <button class="tab-btn" onclick="openTab('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </nav>
        </header>

        <div class="content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 30px; color: #667eea;"><i class="fas fa-chart-line"></i> Dashboard Overview</h2>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="total-employees">0</h3>
                        <p>Total Employees</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-check"></i>
                        <h3 id="active-employees">0</h3>
                        <p>Active Employees</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-building"></i>
                        <h3 id="total-departments">0</h3>
                        <p>Departments</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt"></i>
                        <h3 id="new-hires">0</h3>
                        <p>New Hires This Month</p>
                    </div>
                </div>

                <div style="background: rgba(102, 126, 234, 0.05); padding: 25px; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Recent Activities</h3>
                    <div id="recent-activities">
                        <p><i class="fas fa-info-circle"></i> No recent activities</p>
                    </div>
                </div>
            </div>

            <!-- Employee Entry Tab -->
            <div id="employee-entry" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #667eea;"><i class="fas fa-user-plus"></i> Add New Employee</h2>
                
                <form id="employee-form" onsubmit="addEmployee(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="emp-no">Employee No.</label>
                            <input type="text" id="emp-no" name="empNo" required>
                        </div>
                        <div class="form-group">
                            <label for="area">Area/Location</label>
                            <select id="area" name="area" required>
                                <option value="">Select Area</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="division">Division</label>
                            <select id="division" name="division" required>
                                <option value="">Select Division</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="department">Department</label>
                            <select id="department" name="department" required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="surname">Surname</label>
                            <input type="text" id="surname" name="surname" required>
                        </div>
                        <div class="form-group">
                            <label for="first-name">First Name</label>
                            <input type="text" id="first-name" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="middle-name">Middle Name</label>
                            <input type="text" id="middle-name" name="middleName">
                        </div>
                        <div class="form-group">
                            <label for="tel-no">Tel No.</label>
                            <input type="tel" id="tel-no" name="telNo">
                        </div>
                        <div class="form-group">
                            <label for="birthdate">Birthdate</label>
                            <input type="date" id="birthdate" name="birthdate">
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="MALE">MALE</option>
                                <option value="FEMALE">FEMALE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="civil-status">Civil Status</label>
                            <select id="civil-status" name="civilStatus">
                                <option value="">Select Status</option>
                                <option value="SINGLE">SINGLE</option>
                                <option value="MARRIED">MARRIED</option>
                                <option value="DIVORCED">DIVORCED</option>
                                <option value="SEPARATED">SEPARATED</option>
                                <option value="WIDOWED">WIDOWED</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="religion">Religion</label>
                            <input type="text" id="religion" name="religion">
                        </div>
                        <div class="form-group">
                            <label for="date-hired">Date Hired</label>
                            <input type="date" id="date-hired" name="dateHired">
                        </div>
                        <div class="form-group">
                            <label for="philhealth">PhilHealth No.</label>
                            <input type="text" id="philhealth" name="philhealth">
                        </div>
                        <div class="form-group">
                            <label for="tin">TIN No.</label>
                            <input type="text" id="tin" name="tin">
                        </div>
                        <div class="form-group">
                            <label for="hdmf">HDMF No.</label>
                            <input type="text" id="hdmf" name="hdmf">
                        </div>
                        <div class="form-group">
                            <label for="sss">SSS No.</label>
                            <input type="text" id="sss" name="sss">
                        </div>
                        <div class="form-group">
                            <label for="position">Position Title</label>
                            <select id="position" name="position" required>
                                <option value="">Select Position</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rate-code">Rate Code</label>
                            <input type="text" id="rate-code" name="rateCode">
                        </div>
                        <div class="form-group">
                            <label for="salary">Salary</label>
                            <input type="number" id="salary" name="salary" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="allowance">Allowance</label>
                            <input type="number" id="allowance" name="allowance" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" name="address" rows="3" placeholder="Enter complete address"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Save Employee
                        </button>
                        <button type="reset" class="btn-secondary">
                            <i class="fas fa-undo"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Employee List Tab -->
            <div id="employee-list" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #667eea;"><i class="fas fa-users"></i> Employee Database</h2>
                
                <div class="employee-controls">
                    <input type="text" class="search-box" id="search-employees" placeholder="Search employees...">
                    
                    <div>
                        <button class="btn-primary" onclick="exportEmployees()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn-primary" onclick="document.getElementById('import-file').click()">
                            <i class="fas fa-upload"></i> Import
                        </button>
                        <input type="file" id="import-file" accept=".csv,.xlsx" style="display: none;" onchange="importEmployees(event)">
                        <button class="btn-primary" onclick="printEmployees()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Loading employees...</p>
                </div>

                <table class="employee-table" id="employee-table">
                    <thead>
                    <tr>
                        <th>Employee No.</th>
                        <th>Name</th>
                        <th>Position</th>
                        <th>PhilHealth No.</th>
                        <th>TIN No.</th>
                        <th>HDMF No.</th>
                        <th>SSS No.</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                    <tbody id="employee-table-body">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                                <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                                No employees found. Add your first employee!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #667eea;"><i class="fas fa-cog"></i> System Settings</h2>
                
                <div class="settings-section">
                    <h3><i class="fas fa-list"></i> Dropdown Lists Management</h3>
                    
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn-primary" onclick="syncWithFirebase()">
                            <i class="fas fa-sync"></i> Sync with Firebase
                        </button>
                        <button class="btn-secondary" onclick="testFirebaseConnection()">
                            <i class="fas fa-check"></i> Test Connection
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Areas/Locations</label>
                            <div class="dropdown-list" id="areas-list"></div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="new-area" placeholder="Add new area">
                                <button class="btn-secondary" onclick="addDropdownItem('areas', 'new-area')">Add</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Divisions</label>
                            <div class="dropdown-list" id="divisions-list"></div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="new-division" placeholder="Add new division">
                                <button class="btn-secondary" onclick="addDropdownItem('divisions', 'new-division')">Add</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Departments</label>
                            <div class="dropdown-list" id="departments-list"></div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="new-department" placeholder="Add new department">
                                <button class="btn-secondary" onclick="addDropdownItem('departments', 'new-department')">Add</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Positions</label>
                            <div class="dropdown-list" id="positions-list"></div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="new-position" placeholder="Add new position">
                                <button class="btn-secondary" onclick="addDropdownItem('positions', 'new-position')">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3><i class="fas fa-bell"></i> Email Notifications</h3>
                    
                    <div class="notification-setting">
                        <div>
                            <strong>New Employee Added</strong>
                            <p>Send notification when a new employee is added to the system</p>
                        </div>
                        <div class="toggle-switch" onclick="toggleNotification(this)" data-setting="newEmployee"></div>
                    </div>
                    
                    <div class="notification-setting">
                        <div>
                            <strong>Employee Status Changed</strong>
                            <p>Send notification when employee status is updated</p>
                        </div>
                        <div class="toggle-switch" onclick="toggleNotification(this)" data-setting="statusChange"></div>
                    </div>
                    
                    <div class="notification-setting">
                        <div>
                            <strong>Monthly Reports</strong>
                            <p>Send monthly employee summary reports</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleNotification(this)" data-setting="monthlyReports"></div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>HR Email Address</label>
                        <input type="email" id="hr-email" placeholder="hr@company.com" value="hr@company.com">
                        <button class="btn-primary" onclick="saveHREmail()" style="margin-top: 10px;">
                            <i class="fas fa-save"></i> Save Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Employee</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <form id="edit-form" onsubmit="updateEmployee(event)">
                <input type="hidden" id="edit-employee-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-emp-no">Employee No.</label>
                        <input type="text" id="edit-emp-no" name="empNo" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-area">Area/Location</label>
                        <select id="edit-area" name="area" required>
                            <option value="">Select Area</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-division">Division</label>
                        <select id="edit-division" name="division" required>
                            <option value="">Select Division</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-department">Department</label>
                        <select id="edit-department" name="department" required>
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-surname">Surname</label>
                        <input type="text" id="edit-surname" name="surname" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-first-name">First Name</label>
                        <input type="text" id="edit-first-name" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-middle-name">Middle Name</label>
                        <input type="text" id="edit-middle-name" name="middleName">
                    </div>
                    <div class="form-group">
                        <label for="edit-tel-no">Tel No.</label>
                        <input type="tel" id="edit-tel-no" name="telNo">
                    </div>
                    <div class="form-group">
                        <label for="edit-birthdate">Birthdate</label>
                        <input type="date" id="edit-birthdate" name="birthdate">
                    </div>
                    <div class="form-group">
                        <label for="edit-gender">Gender</label>
                        <select id="edit-gender" name="gender">
                            <option value="">Select Gender</option>
                            <option value="MALE">MALE</option>
                            <option value="FEMALE">FEMALE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-civil-status">Civil Status</label>
                        <select id="edit-civil-status" name="civilStatus">
                            <option value="">Select Status</option>
                            <option value="SINGLE">SINGLE</option>
                            <option value="MARRIED">MARRIED</option>
                            <option value="DIVORCED">DIVORCED</option>
                            <option value="SEPARATED">SEPARATED</option>
                            <option value="WIDOWED">WIDOWED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-religion">Religion</label>
                        <input type="text" id="edit-religion" name="religion">
                    </div>
                    <div class="form-group">
                        <label for="edit-date-hired">Date Hired</label>
                        <input type="date" id="edit-date-hired" name="dateHired">
                    </div>
                    <div class="form-group">
                        <label for="edit-philhealth">PhilHealth No.</label>
                        <input type="text" id="edit-philhealth" name="philhealth">
                    </div>
                    <div class="form-group">
                        <label for="edit-tin">TIN No.</label>
                        <input type="text" id="edit-tin" name="tin">
                    </div>
                    <div class="form-group">
                        <label for="edit-hdmf">HDMF No.</label>
                        <input type="text" id="edit-hdmf" name="hdmf">
                    </div>
                    <div class="form-group">
                        <label for="edit-sss">SSS No.</label>
                        <input type="text" id="edit-sss" name="sss">
                    </div>
                    <div class="form-group">
                        <label for="edit-position">Position Title</label>
                        <select id="edit-position" name="position" required>
                            <option value="">Select Position</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-rate-code">Rate Code</label>
                        <input type="text" id="edit-rate-code" name="rateCode">
                    </div>
                    <div class="form-group">
                        <label for="edit-salary">Salary</label>
                        <input type="number" id="edit-salary" name="salary" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-allowance">Allowance</label>
                        <input type="number" id="edit-allowance" name="allowance" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-status">Status</label>
                        <select id="edit-status" name="status" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-address">Address</label>
                    <textarea id="edit-address" name="address" rows="3" placeholder="Enter complete address"></textarea>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Update Employee
                    </button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let employees = [];
        let isFirebaseConnected = false;
        let dropdownData = {
            areas: ['MAIN', 'NEW PLANT', 'LATECO'],
            divisions: ['BATCHING', 'OVEN', 'DISPATCHING', 'OFFICE', 'PACKAGING', 'SCALING', 'FG CUSTODIAN', 'RM CUSTODIAN', 'GATEKEEPER', 'FIELD', 'UTILITY', 'REPROCESS', 'PRODUCTION CHECKER', 'LOGISTIC CHECKER', 'DRIVER', 'TIMEKEEPER', 'SALES AGENT', 'DELIVERY HELPER', 'QUALITY ASSURANCE', 'TECHNICIAN', 'LOGISTIC DISPATCHER', 'MAINTENANCE', 'MECHANICS'],
            departments: ['PRODUCTION', 'WAREHOUSE', 'LOGISTICS', 'AUDIT', 'HR', 'ADMIN', 'CREDIT', 'SALES', 'ACCOUNTING', 'QA', 'PURCHASING', 'TREASURY'],
            positions: ['PRODUCTION MANAGER', 'PRODUCTION ASSISTANT MANAGER', 'PRODUCTION SUPERVISOR', 'PRODUCTION CREW', 'PRODUCTION CHECKER', 'PRODUCTION ADMIN', 'PRODUCTION MAINTENANCE', 'PRODUCTION HOUSEKEEPER', 'PRODUCTION OPERATOR', 'LOGISTICS DISPATCHER', 'LOGISTICS CHECKER', 'LOGISTICS DRIVER', 'LOGISTICS HELPER', 'LOGISTICS SUPERVISOR', 'LOGISTICS MANAGER', 'AUDIT HEAD', 'PAYROLL AUDIT', 'FIELD AUDITOR', 'DOCUMENT AUDITOR', 'OPERATIONS AUDITOR', 'AUDIT SUPERVISOR', 'INVENTORY SUPERVISOR', 'HR HEAD', 'HR MANAGER', 'HR SUPERVISOR', 'HR ASSISTANT', 'ADMIN HEAD', 'ADMIN ASSISTANT', 'CREDIT HEAD', 'CREDIT SUPERVISOR', 'CREDIT ANALYST', 'CREDIT INVOICER', 'ACCOUNTING SUPERVISOR', 'ACCOUNTING ASSISTANT', 'BOOK KEEPER', 'PAYROLL SUPERVISOR', 'PAYROLL ASSISTANT', 'QA MANAGER', 'QA OIC', 'QA SUPERVISOR', 'QA STAFF', 'PURCHASING HEAD', 'PURCHASING SUPERVISOR', 'PURCHASING ASSISTANT', 'TREASURY SUPERVISOR', 'TREASURY ASSISTANT (CASHIER)', 'SALES DIRECTOR', 'SALES SUPERVISOR', 'SALES AGENT', 'JR. SALES AGENT', 'GATEKEEPER', 'TIME KEEPER', 'INVENTORY AUDIT', 'RM CUSTODIAN', 'MAINTENANCE', 'RND']
        };
        let notificationSettings = {
            newEmployee: false,
            statusChange: false,
            monthlyReports: true
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Suppress Chrome extension errors
            window.addEventListener('error', function(e) {
                if (e.filename && e.filename.includes('chrome-extension://')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Initialize application
            try {
                // Wait for Firebase to load properly
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                console.log('üîÑ Loading dropdown data...');
                await loadDropdownDataFromStorage(); // Load from Firebase/storage first
                
                console.log('üîÑ Populating dropdowns...');
                loadDropdownData(); // Then populate dropdowns
                
                console.log('üîÑ Loading employees...');
                await loadEmployees();
                
                console.log('üîÑ Updating dashboard...');
                updateDashboard();
                
                console.log('üîÑ Loading settings...');
                loadSettings();
                
                console.log('üîÑ Setting up search...');
                setupSearchFilter();
                
                console.log('‚úÖ HR Management System initialized successfully');
                showNotification('System loaded successfully!', 'success');
            } catch (error) {
                console.error('‚ùå Error initializing application:', error);
                showNotification('Error initializing application', 'error');
            }
        });

        // Connection status update
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.innerHTML = '<i class="fas fa-cloud"></i> Firebase Connected';
                status.className = 'connection-status connection-firebase';
                isFirebaseConnected = true;
            } else {
                status.innerHTML = '<i class="fas fa-database"></i> Local Storage';
                status.className = 'connection-status connection-local';
                isFirebaseConnected = false;
            }
        }

        // Tab functionality
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'employee-list') {
                displayEmployees();
            }
        }

        // Load dropdown data from Firebase and localStorage
        async function loadDropdownDataFromStorage() {
            try {
                // Try to load from Firebase first
                if (window.firebaseDB && window.getDoc && window.doc) {
                    const docRef = window.doc(window.firebaseDB, 'settings', 'dropdownData');
                    const docSnap = await window.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const firebaseData = docSnap.data();
                        dropdownData = {
                            areas: firebaseData.areas || dropdownData.areas,
                            divisions: firebaseData.divisions || dropdownData.divisions,
                            departments: firebaseData.departments || dropdownData.departments,
                            positions: firebaseData.positions || dropdownData.positions
                        };
                        console.log('‚úÖ Dropdown data loaded from Firebase:', dropdownData);
                        // Save to localStorage as backup
                        localStorage.setItem('hrDropdownData', JSON.stringify(dropdownData));
                        return;
                    } else {
                        console.log('‚ö†Ô∏è No dropdown data document found in Firebase, creating one...');
                        // Create the document with current data
                        await window.setDoc(docRef, dropdownData);
                        console.log('‚úÖ Created dropdown data document in Firebase');
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load dropdown data from Firebase:', error);
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('hrDropdownData');
            if (saved) {
                dropdownData = JSON.parse(saved);
                console.log('üì¶ Dropdown data loaded from localStorage');
            } else {
                console.log('üîß Using default dropdown data');
            }
        }

        // Load dropdown data into select elements
        function loadDropdownData() {
            const selects = {
                'area': 'areas',
                'division': 'divisions',
                'department': 'departments',
                'position': 'positions',
                'edit-area': 'areas',
                'edit-division': 'divisions',
                'edit-department': 'departments',
                'edit-position': 'positions'
            };

            Object.keys(selects).forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const dataKey = selects[selectId];
                const currentValue = select.value;
                
                // Clear all options
                select.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Select ${dataKey.charAt(0).toUpperCase() + dataKey.slice(1, -1)}`;
                select.appendChild(defaultOption);
                
                // Add all items from dropdownData
                dropdownData[dataKey].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });
                
                // Restore previous selection if it still exists
                if (currentValue && dropdownData[dataKey].includes(currentValue)) {
                    select.value = currentValue;
                }
            });

            updateSettingsDisplay();
        }

        // Add new employee
        async function addEmployee(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const employee = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    dateCreated: new Date().toISOString().split('T')[0]
                };
                
                for (let [key, value] of formData.entries()) {
                    employee[key] = value;
                }
                
                // Try to save to Firebase first, then localStorage as fallback
                const saved = await saveEmployee(employee);
                
                employees.push(employee);
                updateDashboard();
                displayEmployees();
                
                // Reset form
                event.target.reset();
                
                // Show success message
                showNotification('Employee added successfully!', 'success');
                
                // Send notification if enabled
                if (notificationSettings.newEmployee) {
                    sendEmailNotification('newEmployee', employee);
                }
            } catch (error) {
                console.error('Error adding employee:', error);
                showNotification('Error adding employee', 'error');
            }
        }

        // Save employee (Firebase + localStorage fallback)
            // Save employee (Firebase + localStorage fallback)
async function saveEmployee(employee, forceCreate = false) {
    try {
        if (window.firebaseDB && window.addDoc && window.collection) {
            // Check if this should create a new document or update existing
            const shouldCreate = forceCreate || !employee.id || employee.id.includes('.') || employee.id.length < 15;
            
            if (shouldCreate) {
                // Create new employee document
                const { id, ...employeeData } = employee; // Remove old ID if any
                const docRef = await window.addDoc(window.collection(window.firebaseDB, 'employees'), employeeData);
                employee.id = docRef.id;
                console.log('Employee added to Firebase');
            } else {
                try {
                    // Try to update existing document
                    const { id, ...employeeData } = employee;
                    await window.updateDoc(window.doc(window.firebaseDB, 'employees', employee.id), employeeData);
                    console.log('Employee updated in Firebase');
                } catch (updateError) {
                    if (updateError.code === 'not-found') {
                        // Document doesn't exist, create new one
                        const { id, ...employeeData } = employee;
                        const docRef = await window.addDoc(window.collection(window.firebaseDB, 'employees'), employeeData);
                        employee.id = docRef.id;
                        console.log('Employee created in Firebase (update failed)');
                    } else {
                        throw updateError;
                    }
                }
            }
            
            updateConnectionStatus(true);
            return true;
        }
    } catch (error) {
        console.error('Firebase save failed, using localStorage:', error);
        updateConnectionStatus(false);
    }
    
    // Fallback to localStorage
    saveEmployeesToLocalStorage();
    return false;
}

        // Save employees to localStorage
        function saveEmployeesToLocalStorage() {
            try {
                localStorage.setItem('hrEmployees', JSON.stringify(employees));
                console.log('Employees saved to localStorage');
            } catch (error) {
                console.error('Error saving employees to localStorage:', error);
                showNotification('Error saving employee data', 'error');
            }
        }

        // Load employees from Firebase or localStorage
        async function loadEmployees() {
            try {
                // Try Firebase first
                if (window.firebaseDB && window.getDocs && window.collection) {
                    const querySnapshot = await window.getDocs(window.collection(window.firebaseDB, 'employees'));
                    employees = [];
                    querySnapshot.forEach((doc) => {
                        employees.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('Employees loaded from Firebase:', employees.length);
                    updateConnectionStatus(true);
                    return;
                }
            } catch (error) {
                console.error('Firebase load failed, using localStorage:', error);
                updateConnectionStatus(false);
            }
            
            // Fallback to localStorage
            try {
                const saved = localStorage.getItem('hrEmployees');
                if (saved) {
                    employees = JSON.parse(saved);
                    console.log('Employees loaded from localStorage:', employees.length);
                } else {
                    employees = [];
                    console.log('No employees found in localStorage');
                }
                updateConnectionStatus(false);
            } catch (error) {
                console.error('Error loading employees:', error);
                employees = [];
                showNotification('Error loading employee data', 'error');
            }
        }

        // Display employees in table
        // Display employees in table
function displayEmployees() {
    const tbody = document.getElementById('employee-table-body');
    const searchTerm = document.getElementById('search-employees').value.toLowerCase();
    
    if (employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                    No employees found. Add your first employee!
                </td>
            </tr>
        `;
        return;
    }
    
    const filteredEmployees = employees.filter(emp => {
        const fullName = `${emp.surname || ''} ${emp.firstName || ''} ${emp.middleName || ''}`.toLowerCase();
        return fullName.includes(searchTerm) || 
               (emp.empNo && emp.empNo.toLowerCase().includes(searchTerm)) ||
               (emp.position && emp.position.toLowerCase().includes(searchTerm)) ||
               (emp.philhealth && emp.philhealth.toLowerCase().includes(searchTerm)) ||
               (emp.tin && emp.tin.toLowerCase().includes(searchTerm)) ||
               (emp.hdmf && emp.hdmf.toLowerCase().includes(searchTerm)) ||
               (emp.sss && emp.sss.toLowerCase().includes(searchTerm));
    });
    
    tbody.innerHTML = filteredEmployees.map(emp => `
        <tr>
            <td>${emp.empNo || 'N/A'}</td>
            <td>${emp.surname || ''} ${emp.firstName || ''} ${emp.middleName || ''}</td>
            <td>${emp.position || 'N/A'}</td>
            <td>${emp.philhealth || 'N/A'}</td>
            <td>${emp.tin || 'N/A'}</td>
            <td>${emp.hdmf || 'N/A'}</td>
            <td>${emp.sss || 'N/A'}</td>
            <td><span class="status-${(emp.status || 'active').toLowerCase()}">${emp.status || 'Active'}</span></td>
            <td>
                <button class="btn-secondary" onclick="editEmployee('${emp.id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </td>
        </tr>
    `).join('');
}

        // Update dashboard statistics
        function updateDashboard() {
            const totalEmployees = employees.length;
            const activeEmployees = employees.filter(emp => (emp.status || 'Active') === 'Active').length;
            const departments = [...new Set(employees.map(emp => emp.department).filter(d => d))].length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const newHires = employees.filter(emp => {
                if (!emp.dateHired) return false;
                const hireDate = new Date(emp.dateHired);
                return hireDate.getMonth() === currentMonth && hireDate.getFullYear() === currentYear;
            }).length;
            
            document.getElementById('total-employees').textContent = totalEmployees;
            document.getElementById('active-employees').textContent = activeEmployees;
            document.getElementById('total-departments').textContent = departments;
            document.getElementById('new-hires').textContent = newHires;
            
            updateRecentActivities();
        }

        // Update recent activities
        function updateRecentActivities() {
            const recentActivities = document.getElementById('recent-activities');
            const recent = employees
                .filter(emp => emp.dateCreated)
                .sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated))
                .slice(0, 5);
            
            if (recent.length === 0) {
                recentActivities.innerHTML = '<p><i class="fas fa-info-circle"></i> No recent activities</p>';
                return;
            }
            
            recentActivities.innerHTML = recent.map(emp => 
                `<p><i class="fas fa-user-plus"></i> ${emp.firstName || ''} ${emp.surname || ''} added on ${emp.dateCreated}</p>`
            ).join('');
        }

        // Edit employee
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            // Populate edit form
            document.getElementById('edit-employee-id').value = employee.id;
            Object.keys(employee).forEach(key => {
                const element = document.getElementById(`edit-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                if (element) {
                    element.value = employee[key] || '';
                }
            });
            
            // Show modal
            document.getElementById('edit-modal').style.display = 'block';
        }

        // Update employee
        async function updateEmployee(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const employeeId = document.getElementById('edit-employee-id').value;
                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                
                if (employeeIndex === -1) {
                    showNotification('Employee not found!', 'error');
                    return;
                }
                
                const updatedEmployee = { ...employees[employeeIndex] };
                for (let [key, value] of formData.entries()) {
                    updatedEmployee[key] = value;
                }
                
                // Save to Firebase/localStorage
                try {
                    if (window.firebaseDB && window.updateDoc && window.doc && isFirebaseConnected) {
                        const { id, ...employeeData } = updatedEmployee;
                        await window.updateDoc(window.doc(window.firebaseDB, 'employees', updatedEmployee.id), employeeData);
                        console.log('Employee updated in Firebase');
                    } else {
                        saveEmployeesToLocalStorage();
                    }
                } catch (error) {
                    console.error('Firebase update failed:', error);
                    saveEmployeesToLocalStorage();
                }
                
                employees[employeeIndex] = updatedEmployee;
                updateDashboard();
                displayEmployees();
                closeEditModal();
                
                showNotification('Employee updated successfully!', 'success');
                
                if (notificationSettings.statusChange) {
                    sendEmailNotification('statusChange', updatedEmployee);
                }
            } catch (error) {
                console.error('Error updating employee:', error);
                showNotification('Error updating employee', 'error');
            }
        }

        // Delete employee
        async function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                try {
                    // Try Firebase delete
                    if (window.firebaseDB && window.deleteDoc && window.doc && isFirebaseConnected) {
                        await window.deleteDoc(window.doc(window.firebaseDB, 'employees', id));
                    }
                    
                    employees = employees.filter(emp => emp.id !== id);
                    saveEmployeesToLocalStorage();
                    updateDashboard();
                    displayEmployees();
                    showNotification('Employee deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showNotification('Error deleting employee', 'error');
                }
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Export employees to CSV
        function exportEmployees() {
            if (employees.length === 0) {
                showNotification('No employees to export!', 'error');
                return;
            }
            
            const headers = [
                'Employee No', 'Area', 'Division', 'Department', 'Surname', 'First Name', 
                'Middle Name', 'Address', 'Tel No', 'Birthdate', 'Gender', 'Civil Status',
                'Religion', 'Date Hired', 'PhilHealth No', 'TIN No', 'HDMF No', 'SSS No',
                'Position', 'Rate Code', 'Salary', 'Allowance', 'Date Created', 'Status'
            ];
            
            const csvContent = [
                headers.join(','),
                ...employees.map(emp => [
                    emp.empNo, emp.area, emp.division, emp.department, emp.surname,
                    emp.firstName, emp.middleName || '', emp.address, emp.telNo,
                    emp.birthdate, emp.gender, emp.civilStatus, emp.religion,
                    emp.dateHired, emp.philhealth, emp.tin, emp.hdmf, emp.sss,
                    emp.position, emp.rateCode, emp.salary, emp.allowance,
                    emp.dateCreated, emp.status
                ].map(field => `"${field || ''}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `employees_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Employees exported successfully!', 'success');
        }

        // Import employees from CSV
        // Import employees from CSV
// Import employees from CSV
function importEmployees(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim()); // Remove empty lines
            
            if (lines.length < 2) {
                showNotification('CSV file must have headers and at least one data row!', 'error');
                return;
            }
            
            // Parse headers and clean them
            const headers = lines[0].split(',').map(h => h.replace(/["'\r\n]/g, '').trim().toLowerCase());
            console.log('CSV Headers:', headers);
            
            // Create field mapping for common variations
            const fieldMapping = {
                'employee no': 'empNo',
                'employeeno': 'empNo',
                'emp no': 'empNo',
                'empno': 'empNo',
                'employee number': 'empNo',
                'area': 'area',
                'location': 'area',
                'area/location': 'area',
                'division': 'division',
                'department': 'department',
                'dept': 'department',
                'surname': 'surname',
                'last name': 'surname',
                'lastname': 'surname',
                'first name': 'firstName',
                'firstname': 'firstName',
                'fname': 'firstName',
                'middle name': 'middleName',
                'middlename': 'middleName',
                'mname': 'middleName',
                'address': 'address',
                'tel no': 'telNo',
                'phone': 'telNo',
                'telephone': 'telNo',
                'contact': 'telNo',
                'birthdate': 'birthdate',
                'birth date': 'birthdate',
                'bdate': 'birthdate',
                'dob': 'birthdate',
                'gender': 'gender',
                'sex': 'gender',
                'civil status': 'civilStatus',
                'civilstatus': 'civilStatus',
                'marital status': 'civilStatus',
                'religion': 'religion',
                'date hired': 'dateHired',
                'datehired': 'dateHired',
                'hire date': 'dateHired',
                'start date': 'dateHired',
                'philhealth no': 'philhealth',
                'philhealth': 'philhealth',
                'philhealth number': 'philhealth',
                'tin no': 'tin',
                'tin': 'tin',
                'tin number': 'tin',
                'hdmf no': 'hdmf',
                'hdmf': 'hdmf',
                'hdmf number': 'hdmf',
                'pagibig': 'hdmf',
                'sss no': 'sss',
                'sss': 'sss',
                'sss number': 'sss',
                'position': 'position',
                'position title': 'position',
                'job title': 'position',
                'title': 'position',
                'rate code': 'rateCode',
                'ratecode': 'rateCode',
                'salary': 'salary',
                'basic salary': 'salary',
                'wage': 'salary',
                'allowance': 'allowance',
                'allowances': 'allowance',
                'status': 'status',
                'employment status': 'status',
                'date created': 'dateCreated',
                'datecreated': 'dateCreated',
                'created date': 'dateCreated'
            };
            
            const importedEmployees = [];
            let successCount = 0;
            let errorCount = 0;
            
            // Process each data row
            for (let i = 1; i < lines.length; i++) {
                try {
                    const line = lines[i];
                    if (!line.trim()) continue;
                    
                    // Handle CSV parsing with potential commas in quoted fields
                    const values = parseCSVLine(line);
                    
                    if (values.length !== headers.length) {
                        console.warn(`Row ${i + 1}: Column count mismatch. Expected ${headers.length}, got ${values.length}`);
                        errorCount++;
                        continue;
                    }
                    
                    const employee = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        dateCreated: new Date().toISOString().split('T')[0]
                    };
                    
                    // Map CSV columns to employee fields
                    headers.forEach((header, index) => {
                        const fieldName = fieldMapping[header] || header.replace(/\s+/g, '');
                        let value = values[index] ? values[index].replace(/["'\r\n]/g, '').trim() : '';
                        
                        // Convert specific fields
                        if (fieldName === 'salary' || fieldName === 'allowance') {
                            value = value ? parseFloat(value.replace(/[,$]/g, '')) || 0 : 0;
                        } else if (fieldName === 'birthdate' || fieldName === 'dateHired') {
                            value = formatDate(value);
                        } else if (fieldName === 'status') {
                            value = value ? (value.toLowerCase().includes('active') ? 'Active' : 'Inactive') : 'Active';
                        } else if (fieldName === 'gender') {
                            value = value ? value.toUpperCase() : '';
                        } else if (fieldName === 'civilStatus') {
                            value = value ? value.toUpperCase() : '';
                        }
                        
                        employee[fieldName] = value;
                    });
                    
                    // Validate required fields
                    if (!employee.empNo || !employee.firstName || !employee.surname) {
                        console.warn(`Row ${i + 1}: Missing required fields (Employee No, First Name, or Surname)`);
                        errorCount++;
                        continue;
                    }
                    
                    // Check for duplicate employee numbers
                    const existingEmp = employees.find(emp => emp.empNo === employee.empNo);
                    if (existingEmp) {
                        console.warn(`Row ${i + 1}: Employee No ${employee.empNo} already exists`);
                        errorCount++;
                        continue;
                    }
                    
                    importedEmployees.push(employee);
                    successCount++;
                    
                } catch (rowError) {
                    console.error(`Error processing row ${i + 1}:`, rowError);
                    errorCount++;
                }
            }
            
            if (importedEmployees.length === 0) {
                showNotification('No valid employees found in the CSV file!', 'error');
                return;
            }
            
            // Save each employee to Firebase/localStorage
            for (const emp of importedEmployees) {
                await saveEmployee(emp, true); // Force create for imports
                employees.push(emp);
            }
            
            updateDashboard();
            displayEmployees();
            
            const message = `Import completed! ${successCount} employees imported successfully.${errorCount > 0 ? ` ${errorCount} rows had errors.` : ''}`;
            showNotification(message, successCount > 0 ? 'success' : 'error');
            
        } catch (error) {
            console.error('Import error:', error);
            showNotification('Error importing file. Please check the CSV format and try again.', 'error');
        }
    };
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

// Parse CSV line handling quoted fields with commas
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current); // Add the last field
    return result;
}

// Format date strings to YYYY-MM-DD
function formatDate(dateStr) {
    if (!dateStr) return '';
    
    try {
        // Handle various date formats
        let date;
        
        // Try parsing different formats
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // Assume MM/DD/YYYY or DD/MM/YYYY
                let month = parseInt(parts[0]);
                let day = parseInt(parts[1]);
                let year = parseInt(parts[2]);
                
                if (year < 100) {
                    year += 2000; // Convert 2-digit year
                }
                
                date = new Date(year, month - 1, day);
            }
        } else if (dateStr.includes('-')) {
            date = new Date(dateStr);
        } else {
            date = new Date(dateStr);
        }
        
        if (isNaN(date.getTime())) {
            return '';
        }
        
        return date.toISOString().split('T')[0];
    } catch (error) {
        console.warn('Date parsing error:', error);
        return '';
    }
}

        // Print employees
        function printEmployees() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Employee Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #667eea; margin-bottom: 10px; }
                        .header p { color: #666; margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #667eea; color: white; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .status-active { background: #28a745; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
                        .status-inactive { background: #dc3545; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9em; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Employee Report</h1>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                        <p>Total Employees: ${employees.length}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Employee No.</th>
                                <th>Name</th>
                                <th>Position</th>
                                <th>PhilHealth No.</th>
                                <th>TIN No.</th>
                                <th>HDMF No.</th>
                                <th>SSS No.</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employees.map(emp => `
                                <tr>
                                    <td>${emp.empNo || 'N/A'}</td>
                                    <td>${emp.firstName || ''} ${emp.middleName || ''} ${emp.surname || ''}</td>
                                    <td>${emp.department || 'N/A'}</td>
                                    <td>${emp.position || 'N/A'}</td>
                                    <td>${emp.dateHired || 'N/A'}</td>
                                    <td><span class="status-${(emp.status || 'active').toLowerCase()}">${emp.status || 'Active'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>HR Management System - Confidential Document</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Search filter setup
        function setupSearchFilter() {
            const searchBox = document.getElementById('search-employees');
            searchBox.addEventListener('input', displayEmployees);
        }

        // Settings management
        function addDropdownItem(category, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!value) {
                showNotification('Please enter a value!', 'error');
                return;
            }
            
            if (dropdownData[category].includes(value)) {
                showNotification(`${value} already exists in ${category}!`, 'error');
                return;
            }
            
            // Add to dropdown data
            dropdownData[category].push(value);
            
            // Save to storage
            saveDropdownData();
            
            // Refresh all dropdowns
            loadDropdownData();
            
            // Clear input
            input.value = '';
            
            showNotification(`${value} added to ${category} successfully!`, 'success');
        }

        function removeDropdownItem(category, item) {
            if (confirm(`Are you sure you want to remove "${item}" from ${category}?`)) {
                dropdownData[category] = dropdownData[category].filter(i => i !== item);
                saveDropdownData();
                loadDropdownData();
                showNotification(`${item} removed from ${category} successfully!`, 'success');
            }
        }

        // Save dropdown data to Firebase and localStorage
        async function saveDropdownData() {
            try {
                // Save to Firebase first
                if (window.firebaseDB && window.setDoc && window.doc) {
                    const docRef = window.doc(window.firebaseDB, 'settings', 'dropdownData');
                    await window.setDoc(docRef, dropdownData);
                    console.log('Dropdown data saved to Firebase');
                }
            } catch (error) {
                console.error('Failed to save dropdown data to Firebase:', error);
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('hrDropdownData', JSON.stringify(dropdownData));
            console.log('Dropdown data saved to localStorage');
        }

        function updateSettingsDisplay() {
            ['areas', 'divisions', 'departments', 'positions'].forEach(category => {
                const list = document.getElementById(`${category}-list`);
                if (!list) return;
                
                list.innerHTML = dropdownData[category].map(item => `
                    <div class="dropdown-item">
                        <span>${item}</span>
                        <button class="btn-danger" onclick="removeDropdownItem('${category}', '${item}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            });
        }

        function loadSettings() {
            const saved = localStorage.getItem('hrSettings');
            if (saved) {
                notificationSettings = JSON.parse(saved);
            }
            
            // Update toggle switches
            Object.keys(notificationSettings).forEach(setting => {
                const toggle = document.querySelector(`[data-setting="${setting}"]`);
                if (toggle) {
                    toggle.classList.toggle('active', notificationSettings[setting]);
                }
            });
            
            // Load HR email
            const savedEmail = localStorage.getItem('hrEmail');
            if (savedEmail) {
                document.getElementById('hr-email').value = savedEmail;
            }
        }

        function toggleNotification(toggle) {
            const setting = toggle.dataset.setting;
            notificationSettings[setting] = !notificationSettings[setting];
            toggle.classList.toggle('active', notificationSettings[setting]);
            
            localStorage.setItem('hrSettings', JSON.stringify(notificationSettings));
            showNotification('Notification setting updated!', 'success');
        }

        function saveHREmail() {
            const email = document.getElementById('hr-email').value;
            if (email) {
                localStorage.setItem('hrEmail', email);
                showNotification('HR email saved successfully!', 'success');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Manual sync with Firebase
        async function syncWithFirebase() {
            showNotification('Syncing with Firebase...', 'info');
            try {
                console.log('üîÑ Starting manual Firebase sync...');
                await loadDropdownDataFromStorage();
                loadDropdownData();
                showNotification('‚úÖ Successfully synced with Firebase!', 'success');
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                showNotification('‚ùå Sync failed: ' + error.message, 'error');
            }
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            showNotification('Testing Firebase connection...', 'info');
            try {
                if (!window.firebaseDB) {
                    throw new Error('Firebase not initialized');
                }

                if (!window.getDoc || !window.doc) {
                    throw new Error('Firebase functions not available');
                }

                const docRef = window.doc(window.firebaseDB, 'settings', 'dropdownData');
                const docSnap = await window.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('‚úÖ Firebase dropdown data:', data);
                    showNotification('‚úÖ Firebase connected! Found dropdown data.', 'success');
                } else {
                    console.log('‚ö†Ô∏è Document does not exist');
                    showNotification('‚ö†Ô∏è Connected but no dropdown data found.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Firebase test failed:', error);
                showNotification('‚ùå Firebase test failed: ' + error.message, 'error');
            }
        }
        async function sendEmailNotification(type, employee) {

            const hrEmail = localStorage.getItem('hrEmail') || 'hr@company.com';
            let subject, body;
            
            switch (type) {
                case 'newEmployee':
                    subject = 'New Employee Added';
                    body = `A new employee has been added:\n\nName: ${employee.firstName} ${employee.surname}\nEmployee No: ${employee.empNo}\nDepartment: ${employee.department}\nPosition: ${employee.position}`;
                    break;
                case 'statusChange':
                    subject = 'Employee Status Updated';
                    body = `Employee status has been updated:\n\nName: ${employee.firstName} ${employee.surname}\nEmployee No: ${employee.empNo}\nNew Status: ${employee.status}`;
                    break;
            }
            
            // Simulate email sending
            console.log(`Email sent to ${hrEmail}:\nSubject: ${subject}\nBody: ${body}`);
            showNotification(`Email notification sent to ${hrEmail}`, 'success');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js';

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDcIjTQsVEqGsjG4MDTYXeyG-pt8oZGSW8",
            authDomain: "hr-management-system-a316e.firebaseapp.com",
            projectId: "hr-management-system-a316e",
            storageBucket: "hr-management-system-a316e.firebasestorage.app",
            messagingSenderId: "987135397487",
            appId: "1:987135397487:web:a4213c04591051cbc5879a"
        };

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // Make Firebase functions available globally
            window.firebaseDB = db;
            window.addDoc = addDoc;
            window.getDocs = getDocs;
            window.collection = collection;
            window.doc = doc;
            window.updateDoc = updateDoc;
            window.deleteDoc = deleteDoc;
            window.query = query;
            window.orderBy = orderBy;
            window.getDoc = getDoc;
            window.setDoc = setDoc;

            console.log('Firebase initialized successfully');
            
            // Update connection status after Firebase loads
            setTimeout(() => {
                if (window.updateConnectionStatus) {
                    window.updateConnectionStatus(true);
                }
            }, 1000);
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            setTimeout(() => {
                if (window.updateConnectionStatus) {
                    window.updateConnectionStatus(false);
                }
            }, 1000);
        }
    </script>
</body>
</html>